# Pre-liquidation Contract Formal Verification

This folder contains the
[CVL](https://docs.certora.com/en/latest/docs/cvl/index.html)
specification and verification setup for the
[pre-liquidation](../src/PreLiquidation.sol) contract on [Morpho
Blue](https://app.morpho.org/?network=mainnet) using the [Certora
Prover](https://www.certora.com/).

## Getting Started

This project depends on two different versions of
[Solidity](https://soliditylang.org/) which are required for running
the verification. The compiler binaries should be available under the
following path names:

  - `solc-0.8.19` for the solidity compiler version `0.8.19`, which is
    used for `MorphoBlue`;
  - `solc-0.8.27` for the solidity compiler version `0.8.27`, which is
    used for `PreLiquidation`.

The verification is performed on modified source files, which can be
generated by running the following command.

``` shell
make -C certora munged
```

### Installing the Certora Prover

The Certora CLI can be installed by running `python3 -m pip3 install
certora-cli`. Detailed installation instructions can be found on
Certora's official
[documentation](https://docs.certora.com/en/latest/docs/user-guide/install.html).

To verifying a specification, run the command `certoraRun Spec.conf`
where `Spec.conf` is the configuration file of the matching CVL
specification. Configuration files are available in
[`certora/conf`](./confs). Please ensure that `CERTORA_KEY` is set up
in your environment.

## Overview

The PreLiquidation contract enables Morpho Blue borrowers to set up a
safer liquidation plan on a given position, thus preventing undesired
liquidations.

### Reentrancy

PreLiquidation only interacts with Morpho Blue and with the loan token
of the vault.  This is checked in
[`Reentrancy.spec`](specs/Reentrancy.spec).  Informally, the loan
token and the markets of Morpho Blue are trusted.


## Verification architecture

### Folders and file structure

The [`certora/specs`](specs) folder contains the following files:

- [`Reentrancy.spec`](specs/Reentrancy.spec) checks that
  PreLiquidation is reentrancy safe by making sure that there are no
  untrusted external calls.

The [`certora/confs`](confs) folder contains a configuration file for
each corresponding specification file.

The [`certora/helpers`](helpers) folder contains helper contracts that
enable the verification of PreLiquidation. Notably, this allows
handling the fact that library functions should be called from a
contract to be verified independently, and it allows defining needed
getters.

## TODO

- [ ] Provide an overview of the specification.
- [ ] Update the verification architecture.
